version: '3.6'

services:
  redroid:
    image: redroid/redroid:14.0.0-latest
    privileged: true
    networks:
      - traefik
    ports:
      - target: 5555
        published: 5555
        protocol: tcp
        mode: host
    command:
      - androidboot.redroid_width=1080
      - androidboot.redroid_height=2400
      - androidboot.redroid_dpi=480
      - androidboot.use_memfd=1
      - ro.secure=0
      - androidboot.redroid_gpu_mode=guest
      - ro.adb.secure=0
      - ro.debuggable=1
      - androidboot.redroid_net_ndns=8.8.8.8,8.8.4.4
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: ["${NODE}"]
      restart_policy:
        condition: any
        delay: 10s
    logging:
      driver: loki
      options:
        loki-url: ${LOKI_URL}

  scrcpy-web:
    image: srsdev/ws-scrcpy:latest
    networks:
      - traefik
    environment:
      - ANDROID_DEVICE=redroid:5555
      - WS_SCRCPY_SERVER_PORT=8000
    deploy:
      mode: replicated
      replicas: 0  # Iniciar manualmente despu√©s
      placement:
        constraints: ["${NODE}"]
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 5
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.${SERVICE_NAME}.entrypoints=web"
        - "traefik.http.routers.${SERVICE_NAME}.rule=Host(`${DOMAIN_NAME}`)"
        - "traefik.http.services.${SERVICE_NAME}.loadbalancer.server.port=8000"
    logging:
      driver: loki
      options:
        loki-url: ${LOKI_URL}

networks:
  traefik:
    external: true
    name: traefik-network
