version: '3.6'

services:
  redroid:
    image: redroid/redroid:12.0.0-latest
    privileged: true
    networks:
      - traefik
    ports:
      - target: 5555
        published: 5555
        protocol: tcp
        mode: host
    command:
      - androidboot.redroid_width=1080
      - androidboot.redroid_height=1920
      - androidboot.redroid_dpi=420
      - androidboot.use_memfd=1 
      - ro.secure=0
      - androidboot.redroid_gpu_mode=guest
    deploy:
      placement:
        constraints: ["${NODE}"]
      restart_policy:
        condition: any
        delay: 5s
    logging:
      driver: loki
      options:
        loki-url: ${LOKI_URL}
    healthcheck:
      test: ["CMD-SHELL", "getprop sys.boot_completed | grep 1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

  scrcpy-web:
    image: srsdev/ws-scrcpy:latest
    networks:
      - traefik
    environment:
      - ADB_SERVER_IP=redroid
      - ADB_SERVER_PORT=5555
    deploy:
      placement:
        constraints: ["${NODE}"]
      restart_policy:
        condition: on-failure
        delay: 15s
        max_attempts: 5
        window: 120s
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.${SERVICE_NAME}.entrypoints=web"
        - "traefik.http.routers.${SERVICE_NAME}.rule=Host(`${DOMAIN_NAME}`)"
        - "traefik.http.services.${SERVICE_NAME}.loadbalancer.server.port=8000"
    logging:
      driver: loki
      options:
        loki-url: ${LOKI_URL}

networks:
  traefik:
    external: true
    name: traefik-network
